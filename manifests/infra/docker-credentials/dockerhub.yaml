# =============================================================================
# CLUSTER EXTERNAL SECRET - DOCKERHUB CREDENTIALS
# =============================================================================
# Docs: https://external-secrets.io/latest/api/clusterexternalsecret/
#
# Creates dockerhub-credentials secret in all namespaces with label:
#   dockerhub-pull: "true"
#
# Prerequisites:
#   1. Add secrets to Doppler (project: example, config: shared):
#      - DOCKERHUB_USERNAME: your DockerHub username
#      - DOCKERHUB_PULL_TOKEN: your DockerHub access token
#   2. ClusterSecretStore "doppler-shared" must be ready
#
# Usage in services:
#   1. Add label to namespace: dockerhub-pull: "true"
#   2. Add to deployment spec:
#      spec:
#        template:
#          spec:
#            imagePullSecrets:
#              - name: dockerhub-credentials
#
# Alternative approaches:
#   - Per-service ExternalSecret: if different services use different registries
#   - Global secret + copy: use kubernetes-reflector to copy secret to namespaces
# =============================================================================
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: dockerhub-credentials
spec:
  # Name of ExternalSecret created in each namespace
  externalSecretName: dockerhub-credentials

  # Select namespaces with this label
  namespaceSelectors:
    - matchLabels:
        dockerhub-pull: "true"

  # How often to check for new matching namespaces
  refreshTime: "1m"

  externalSecretSpec:
    secretStoreRef:
      name: doppler-shared
      kind: ClusterSecretStore

    refreshInterval: "1m"

    target:
      name: dockerhub-credentials
      creationPolicy: Owner
      template:
        type: kubernetes.io/dockerconfigjson
        data:
          .dockerconfigjson: |
            {"auths":{"https://index.docker.io/v1/":{"username":"{{ .username }}","password":"{{ .password }}","auth":"{{ printf "%s:%s" .username .password | b64enc }}"},"https://registry-1.docker.io":{"username":"{{ .username }}","password":"{{ .password }}","auth":"{{ printf "%s:%s" .username .password | b64enc }}"}}}

    data:
      - secretKey: username
        remoteRef:
          key: DOCKERHUB_USERNAME
      - secretKey: password
        remoteRef:
          key: DOCKERHUB_PULL_TOKEN
