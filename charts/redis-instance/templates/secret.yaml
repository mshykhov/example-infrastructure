{{- if and .Values.auth.enabled (not .Values.auth.existingSecret) }}
{{- $secretName := include "redis-instance.fullname" . }}
{{- $secretKey := .Values.auth.secretKey }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
# =============================================================================
# REDIS SECRET - AUTO-GENERATED PASSWORD
# =============================================================================
# Similar to CloudNativePG - auto-generate password if not provided.
# Password is generated once and persists across upgrades using lookup.
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "redis-instance.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if and $existingSecret $existingSecret.data (index $existingSecret.data $secretKey) }}
  {{ $secretKey }}: {{ index $existingSecret.data $secretKey }}
  {{- else }}
  {{ $secretKey }}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
{{- end }}
