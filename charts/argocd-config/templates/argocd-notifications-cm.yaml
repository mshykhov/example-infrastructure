apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.telegram: |
    token: $telegram-token

  context: |
    argocdUrl: https://argocd.{{ .Values.global.tailnet }}.ts.net

  template.app-deployed: |
    message: |
      {{`{{- $revision := .app.status.sync.revision -}}`}}
      {{`{{- $shortRev := (trunc 7 $revision) -}}`}}
      {{`{{- $repoURL := "" -}}`}}
      {{`{{- if .app.spec.source -}}`}}
        {{`{{- $repoURL = .app.spec.source.repoURL -}}`}}
      {{`{{- else if .app.spec.sources -}}`}}
        {{`{{- $repoURL = (index .app.spec.sources 0).repoURL -}}`}}
      {{`{{- end -}}`}}
      {{`{{- $commitURL := "" -}}`}}
      {{`{{- if contains "github.com" $repoURL -}}`}}
        {{`{{- $commitURL = printf "%s/commit/%s" (trimSuffix ".git" $repoURL) $revision -}}`}}
      {{`{{- end -}}`}}
      âœ… <b>{{`{{ .app.metadata.name }}`}}</b>

      ğŸ“¦ Deployed successfully
      ğŸ· Namespace: <code>{{`{{ .app.spec.destination.namespace }}`}}</code>
      {{`{{- if $commitURL }}`}}
      ğŸ”— Revision: <a href="{{`{{ $commitURL }}`}}">{{`{{ $shortRev }}`}}</a>
      {{`{{- else }}`}}
      ğŸ”— Revision: <code>{{`{{ $shortRev }}`}}</code>
      {{`{{- end }}`}}
      {{`{{- if (call .repo.GetCommitMetadata .app.status.sync.revision).Message }}`}}
      ğŸ’¬ {{`{{ (call .repo.GetCommitMetadata .app.status.sync.revision).Message | trunc 100 }}`}}
      {{`{{- end }}`}}

      ğŸ”— <a href="{{`{{ .context.argocdUrl }}`}}/applications/{{`{{ .app.metadata.name }}`}}">Open in ArgoCD</a>

  template.app-sync-failed: |
    message: |
      âŒ <b>{{`{{ .app.metadata.name }}`}}</b>

      ğŸš« Sync failed
      ğŸ· Namespace: <code>{{`{{ .app.spec.destination.namespace }}`}}</code>
      {{`{{- if .app.status.operationState.message }}`}}
      âš ï¸ Error: {{`{{ .app.status.operationState.message | trunc 200 }}`}}
      {{`{{- end }}`}}
      {{`{{- range $c := .app.status.conditions }}`}}
      â€¢ {{`{{ $c.type }}`}}: {{`{{ $c.message | trunc 100 }}`}}
      {{`{{- end }}`}}

      ğŸ”— <a href="{{`{{ .context.argocdUrl }}`}}/applications/{{`{{ .app.metadata.name }}`}}?operation=true">View Details</a>

  template.app-health-degraded: |
    message: |
      âš ï¸ <b>{{`{{ .app.metadata.name }}`}}</b>

      ğŸ’” Health degraded
      ğŸ· Namespace: <code>{{`{{ .app.spec.destination.namespace }}`}}</code>
      ğŸ“Š Status: <code>{{`{{ .app.status.health.status }}`}}</code>
      {{`{{- range $c := .app.status.conditions }}`}}
      â€¢ {{`{{ $c.type }}`}}: {{`{{ $c.message | trunc 100 }}`}}
      {{`{{- end }}`}}

      ğŸ”— <a href="{{`{{ .context.argocdUrl }}`}}/applications/{{`{{ .app.metadata.name }}`}}">Open in ArgoCD</a>

  template.app-sync-running: |
    message: |
      ğŸ”„ <b>{{`{{ .app.metadata.name }}`}}</b>

      â³ Sync in progress
      ğŸ· Namespace: <code>{{`{{ .app.spec.destination.namespace }}`}}</code>
      ğŸ”— Revision: <code>{{`{{ .app.status.sync.revision | trunc 7 }}`}}</code>

  template.app-sync-succeeded: |
    message: |
      âœ“ <b>{{`{{ .app.metadata.name }}`}}</b>

      ğŸ”„ Sync completed
      ğŸ· Namespace: <code>{{`{{ .app.spec.destination.namespace }}`}}</code>
      ğŸ”— Revision: <code>{{`{{ .app.status.sync.revision | trunc 7 }}`}}</code>

  trigger.on-deployed: |
    - description: Application is synced and healthy
      oncePer: app.status.operationState.syncResult.revision
      send:
        - app-deployed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  trigger.on-sync-failed: |
    - description: Application sync has failed
      oncePer: app.status.operationState.syncResult.revision
      send:
        - app-sync-failed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Error', 'Failed']

  trigger.on-health-degraded: |
    - description: Application health has degraded
      oncePer: app.status.operationState.syncResult.revision
      send:
        - app-health-degraded
      when: app.status.health.status == 'Degraded'

  trigger.on-sync-running: |
    - description: Application sync is running
      oncePer: app.status.operationState.syncResult.revision
      send:
        - app-sync-running
      when: app.status.operationState != nil and app.status.operationState.phase in ['Running']

  subscriptions: |
    # Deploy notifications - only for apps with deploy-notify=true label
    - recipients:
        - telegram:{{ .Values.global.telegram.chatId }}|{{ .Values.global.telegram.topics.deploys }}
      selector: deploy-notify=true
      triggers:
        - on-deployed
    # Info notifications - all apps
    - recipients:
        - telegram:{{ .Values.global.telegram.chatId }}|{{ .Values.global.telegram.topics.info }}
      triggers:
        - on-sync-running
    # Critical notifications - all apps
    - recipients:
        - telegram:{{ .Values.global.telegram.chatId }}|{{ .Values.global.telegram.topics.critical }}
      triggers:
        - on-sync-failed
    # Warning notifications - all apps
    - recipients:
        - telegram:{{ .Values.global.telegram.chatId }}|{{ .Values.global.telegram.topics.warning }}
      triggers:
        - on-health-degraded
