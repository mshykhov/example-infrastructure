# =============================================================================
# APPLICATIONSET - REDIS × SERVICES × ENVIRONMENTS
# =============================================================================
# Docs: https://github.com/bitnami/charts/tree/main/bitnami/redis
# Chart: oci://registry-1.docker.io/bitnamicharts/redis
#
# Matrix Generator: databases/*/redis/*.yaml × environments (dev, prd)
# Each microservice can have multiple Redis instances.
#
# Structure:
#   databases/<service>/redis/<instance-name>.yaml
#   databases/<service>/redis/<instance-name>-<env>.yaml  (optional, per-env overrides)
#
# Examples:
#   databases/example-api/redis/cache.yaml          → base config (all envs)
#   databases/example-api/redis/cache-dev.yaml      → dev overrides (optional)
#   databases/example-api/redis/cache-prd.yaml      → prd overrides (optional)
#
# Value precedence (lowest to highest):
#   1. Environment defaults (helm-values/data/redis-<env>-defaults.yaml)
#   2. Service config (databases/<service>/redis/<instance>.yaml)
#   3. Service + env config (databases/<service>/redis/<instance>-<env>.yaml)
#
# GENERATED SERVICES (Bitnami Redis):
# ----------------------------------
# Service naming: <service>-<instance>-redis-<env>-<suffix>
#
# Example for databases/example-api/redis/cache.yaml (dev):
#   Release name: example-api-cache-redis-dev
#
#   Services:
#     example-api-cache-redis-dev-master    → master (read/write) :6379
#     example-api-cache-redis-dev-replicas  → replicas (read-only) :6379
#     example-api-cache-redis-dev-headless  → headless service
#
#   Secret:
#     example-api-cache-redis-dev           → key: redis-password
#
# Connection: <release>-master.<namespace>.svc.cluster.local:6379
# =============================================================================
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: redis-clusters
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          - list:
              elements:
                - env: dev
                - env: prd
          - git:
              repoURL: {{ .Values.deploy.repoURL }}
              revision: {{ .Values.deploy.targetRevision }}
              files:
                - path: databases/*/redis/*.yaml
  template:
    metadata:
      # service-instance-redis-env (e.g., example-api-cache-redis-dev)
      name: '{{`{{ index .path.segments 1 }}`}}-{{`{{ trimSuffix ".yaml" .path.filename }}`}}-redis-{{`{{ .env }}`}}'
      labels:
        app: '{{`{{ index .path.segments 1 }}`}}'
        instance: '{{`{{ trimSuffix ".yaml" .path.filename }}`}}'
        env: '{{`{{ .env }}`}}'
        type: redis
    spec:
      project: default
      sources:
        - repoURL: registry-1.docker.io/bitnamicharts
          chart: redis
          targetRevision: "19.6.4"
          helm:
            ignoreMissingValueFiles: true
            valueFiles:
              # 1. Environment defaults (base)
              - $infra/helm-values/data/redis-{{`{{ .env }}`}}-defaults.yaml
              # 2. Service config (overrides defaults)
              - $deploy/{{`{{ .path.path }}`}}/{{`{{ .path.filename }}`}}
              # 3. Service + env config (optional, highest priority)
              - $deploy/{{`{{ .path.path }}`}}/{{`{{ trimSuffix ".yaml" .path.filename }}`}}-{{`{{ .env }}`}}.yaml
        - repoURL: {{ .Values.deploy.repoURL }}
          targetRevision: {{ .Values.deploy.targetRevision }}
          ref: deploy
        - repoURL: {{ .Values.spec.source.repoURL }}
          targetRevision: {{ .Values.spec.source.targetRevision }}
          ref: infra
      destination:
        server: {{ .Values.spec.destination.server }}
        namespace: '{{`{{ index .path.segments 1 }}`}}-{{`{{ .env }}`}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
