# NGINX Ingress Controller
# Docs: https://kubernetes.github.io/ingress-nginx/
# Chart: https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx

controller:
  # Auto-reload on ConfigMap changes (Reloader)
  # Docs: https://kubernetes.github.io/ingress-nginx/examples/customization/custom-headers/#caveats
  podAnnotations:
    reloader.stakater.com/auto: "true"

  # ClusterIP - Tailscale Service will expose it
  service:
    type: ClusterIP

  # Ingress class
  ingressClassResource:
    name: nginx
    enabled: true
    default: true

  # Enable for oauth2-proxy auth annotations
  config:
    use-forwarded-headers: "true"
    allow-snippet-annotations: "true"
    annotations-risk-level: "Critical"
    # Fix X-Forwarded-Port for HTTPS traffic from Tailscale
    # Docs: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#proxy-set-headers
    proxy-set-headers: "ingress-nginx/nginx-custom-headers"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Security
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    runAsGroup: 101

  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE
    readOnlyRootFilesystem: false
