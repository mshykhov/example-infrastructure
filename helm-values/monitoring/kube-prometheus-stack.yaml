# =============================================================================
# KUBE-PROMETHEUS-STACK VALUES
# =============================================================================
# Official docs: https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack
# Optimized for k3s single-node (4 CPU, 8GB RAM)
# Grafana behind oauth2-proxy (anonymous mode)
# =============================================================================

# =============================================================================
# GRAFANA
# =============================================================================
# Docs: https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/anonymous-auth
grafana:
  enabled: true

  # Skip password generation - we use anonymous auth behind oauth2-proxy
  adminPassword: "admin"

  # Anonymous access - authentication handled by oauth2-proxy
  # https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/anonymous-auth
  grafana.ini:
    auth.anonymous:
      enabled: true
      org_name: Main Org.
      org_role: Admin
    auth:
      disable_login_form: true
    server:
      root_url: "%(protocol)s://%(domain)s/"

  # No ingress - accessed via protected-services chart
  ingress:
    enabled: false

  # Persistence via Longhorn
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 5Gi

  # Resources for k3s
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Default dashboards
  defaultDashboardsEnabled: true
  defaultDashboardsTimezone: utc

  # Additional data sources
  # https://grafana.com/docs/grafana/latest/datasources/loki/
  additionalDataSources:
    - name: Loki
      type: loki
      url: http://loki.monitoring.svc.cluster.local:3100
      access: proxy
      isDefault: false

# =============================================================================
# PROMETHEUS
# =============================================================================
prometheus:
  enabled: true

  prometheusSpec:
    retention: 15d
    retentionSize: "10GB"

    # Storage via Longhorn
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi

    # Resources for k3s
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

    # Discover all ServiceMonitors/PodMonitors
    # https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#prometheusioscrape
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

  ingress:
    enabled: false

# =============================================================================
# ALERTMANAGER
# =============================================================================
alertmanager:
  enabled: true

  alertmanagerSpec:
    # Mount Telegram secrets
    # https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#alertmanager
    secrets:
      - telegram-secrets

    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

  ingress:
    enabled: false

  # Alertmanager configuration
  # https://prometheus.io/docs/alerting/latest/configuration/
  config:
    global:
      resolve_timeout: 5m

    # Routing tree
    route:
      receiver: 'telegram-info'
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      routes:
        # Critical alerts â†’ Critical topic
        - receiver: 'telegram-critical'
          matchers:
            - severity = critical
          continue: false

        # Warning alerts â†’ Warning topic
        - receiver: 'telegram-warning'
          matchers:
            - severity = warning
          continue: false

        # Watchdog and info â†’ Info topic
        - receiver: 'telegram-info'
          matchers:
            - alertname = Watchdog
          repeat_interval: 24h
          continue: false

    # Inhibit rules - critical suppresses warning for same alertname
    inhibit_rules:
      - source_matchers:
          - severity = critical
        target_matchers:
          - severity = warning
        equal: ['alertname', 'namespace']

    # Receivers
    receivers:
      - name: 'telegram-critical'
        telegram_configs:
          - bot_token_file: /etc/alertmanager/secrets/telegram-secrets/bot-token
            chat_id: -1003078665133
            message_thread_id: 2
            parse_mode: 'HTML'
            send_resolved: true
            message: |
              {{ if eq .Status "firing" }}ðŸ”´ <b>CRITICAL</b>{{ else }}âœ… <b>RESOLVED</b>{{ end }}
              <b>Alert:</b> {{ .CommonLabels.alertname }}
              <b>Namespace:</b> {{ .CommonLabels.namespace }}
              {{ range .Alerts }}
              {{ .Annotations.summary }}
              {{ end }}

      - name: 'telegram-warning'
        telegram_configs:
          - bot_token_file: /etc/alertmanager/secrets/telegram-secrets/bot-token
            chat_id: -1003078665133
            message_thread_id: 5
            parse_mode: 'HTML'
            send_resolved: true
            message: |
              {{ if eq .Status "firing" }}ðŸŸ  <b>WARNING</b>{{ else }}âœ… <b>RESOLVED</b>{{ end }}
              <b>Alert:</b> {{ .CommonLabels.alertname }}
              <b>Namespace:</b> {{ .CommonLabels.namespace }}
              {{ range .Alerts }}
              {{ .Annotations.summary }}
              {{ end }}

      - name: 'telegram-info'
        telegram_configs:
          - bot_token_file: /etc/alertmanager/secrets/telegram-secrets/bot-token
            chat_id: -1003078665133
            message_thread_id: 7
            parse_mode: 'HTML'
            send_resolved: false
            message: |
              âšª <b>INFO</b>
              <b>Alert:</b> {{ .CommonLabels.alertname }}
              {{ range .Alerts }}
              {{ .Annotations.summary }}
              {{ end }}

# =============================================================================
# NODE EXPORTER
# =============================================================================
nodeExporter:
  enabled: true

prometheus-node-exporter:
  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: 200m
      memory: 64Mi

# =============================================================================
# KUBE-STATE-METRICS
# =============================================================================
kubeStateMetrics:
  enabled: true

kube-state-metrics:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# =============================================================================
# PROMETHEUS OPERATOR
# =============================================================================
prometheusOperator:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
